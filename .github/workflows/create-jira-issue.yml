name: Create Jira issue

on:
  issues:
    types: [opened]

jobs:
  create-issue:
    name: Create Jira issue
    runs-on: ubuntu-latest

    steps:
      - name: Login
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Checkout dev branch (if needed)
        uses: actions/checkout@v4
        with:
          ref: dev

      # GitHub Issue Form íŒŒì‹± (ìˆìœ¼ë©´ ì‚¬ìš© / ì—†ìœ¼ë©´ ë„˜ì–´ê°)
      - name: Issue Parser
        id: issue-parser
        uses: stefanbuck/github-issue-parser@v3
        with:
          template-path: .github/ISSUE_TEMPLATE/issue_form.yml

      - name: Log Issue Parser
        run: echo '${{ steps.issue-parser.outputs.jsonString }}'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ì—¬ê¸°ê°€ "ë‚´ í…œí”Œë¦¿"ì„ êµ¬ì„±í•˜ëŠ” ê³³ì…ë‹ˆë‹¤ (Markdown â†’ Jiraìœ„í‚¤ ë³€í™˜)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Convert Markdown template to Jira Syntax
        id: md2jira
        uses: peter-evans/jira2md@v1
        with:
          mode: md2jira
          input-text: |
            ### Github Issue Link
            - ${{ github.event.issue.html_url }}

            ## ğŸ“– ì „ì²´ ì„¤ëª…
            > ì‚¬ìš©ìì˜ ê´€ì ì—ì„œ ì–´ë–¤ íë¦„ì„ ë§Œë“¤ê³  ì‹¶ì€ì§€, ê·¸ë¦¬ê³  ìˆ˜í–‰í•´ì•¼ í•  ì‘ì—… ë‚´ìš©ì„ ê°„ëµí•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.  
            > ì˜ˆ) ì‚¬ìš©ìëŠ” Navbarë¥¼ í†µí•´ ë‚´ ì •ë³´/ë¡œê·¸ì•„ì›ƒ/ëŒ€ì‹œë³´ë“œ ë©”ë‰´ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.
            - í•­ëª©
            - í•­ëª©
            - í•­ëª©

            ---

            ## ğŸ“‘ ì„¸ë¶€ ê³„íš (Checklist)
            - [ ] í•­ëª©
            - [ ] í•­ëª©
            - [ ] í•­ëª©

            ---

            ## âœ… ì™„ë£Œ ì¡°ê±´ (Acceptance Criteria)
            > êµ¬í˜„ í›„ ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•˜ëŠ” ë™ì‘/ì¡°ê±´ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.  
            > ì˜ˆ) ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í´ë¦­ ì‹œ í˜ì´ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ì´ë™í•œë‹¤.
            - [ ] í•­ëª©
            - [ ] í•­ëª©
            - [ ] í•­ëª©

            ---

            ## ğŸ“š ì°¸ê³  ìë£Œ
            - í•­ëª©
            - í•­ëª©
            - í•­ëª©

            ---

            ### ì›ë¬¸(GitHub Issue Body)
            ${{ github.event.issue.body }}

      # Jira ì´ìŠˆ ìƒì„±
      - name: Create Issue
        id: create
        uses: atlassian/gajira-create@v3
        with:
          # â† í”„ë¡œì íŠ¸ í‚¤(ì˜ˆ: TS ë¡œ ë°”ê¾¸ì„¸ìš”)
          project: TS
          # ì´ìŠˆ íƒ€ì… (ì›ë˜ Sub-taskë¥¼ ì‚¬ìš©í•˜ì…¨ê¸°ì— ìœ ì§€)
          issuetype: Sub-task
          summary: "${{ github.event.issue.title }}"
          description: "${{ steps.md2jira.outputs['output-text'] }}"
          fields: |
            {
              "parent": {
                "key": "${{ steps.issue-parser.outputs.issueparser_parentKey }}"
              }
            }

      - name: Log created issue
        run: echo "Jira Issue ${{ steps.issue-parser.outputs.issueparser_parentKey }}/${{ steps.create.outputs.issue }} was created"

      # ë¸Œëœì¹˜ ìƒì„±(ì›í•˜ì‹¤ ê²½ìš° ìœ ì§€)
      - name: Checkout dev again
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Create branch with Ticket number
        run: |
          BRANCH_NAME="${{ steps.issue-parser.outputs.issueparser_branchPrefix }}/#${{ steps.issue-parser.outputs.issueparser_parentKey }}-${{ steps.issue-parser.outputs.issueparser_branchName }}"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

      - name: Update issue title on GitHub
        uses: actions-cool/issues-helper@v3
        with:
          actions: update-issue
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "${{ steps.create.outputs.issue }} ${{ github.event.issue.title }}"
