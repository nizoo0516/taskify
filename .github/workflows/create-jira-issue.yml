name: Create Jira issue

on:
  workflow_dispatch:
  issues:
    types: [opened]

jobs:
  create-issue:
    name: Create Jira issue
    runs-on: ubuntu-latest

    steps:
      - name: Login
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Checkout dev branch (if needed)
        uses: actions/checkout@v4
        with:
          ref: dev

      # GitHub Issue Form íŒŒì‹±
      - name: Issue Parser
        id: issue-parser
        uses: stefanbuck/github-issue-parser@v3
        with:
          template-path: .github/ISSUE_TEMPLATE/issue_form.yml

      - name: Log Issue Parser JSON
        run: echo '${{ steps.issue-parser.outputs.jsonString }}'

      # Markdown â†’ Jira ë³€í™˜
      - name: Convert Markdown template to Jira Syntax
        id: md2jira
        uses: peter-evans/jira2md@v1
        with:
          mode: md2jira
          input-text: |
            ### Github Issue [TS-24] Link
            - ${{ github.event.issue.html_url }}

            ## ğŸ“– ì „ì²´ ì„¤ëª…
            ${{ steps.issue-parser.outputs.details_md }}

            ---

            ## ğŸ“‘ ì„¸ë¶€ ê³„íš (Checklist)
            ${{ steps.issue-parser.outputs.tasks_md }}

            ---

            ## âœ… ì™„ë£Œ ì¡°ê±´ (Acceptance Criteria)
            > êµ¬í˜„ í›„ ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•˜ëŠ” ë™ì‘/ì¡°ê±´ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.  
            > ì˜ˆ) ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í´ë¦­ ì‹œ í˜ì´ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ì´ë™í•œë‹¤.

            ---

            ## ğŸ“š ì°¸ê³  ìë£Œ
            - (í•„ìš”ì‹œ ì¶”ê°€)

            ---

            ### ì›ë¬¸(GitHub Issue Body)
            ${{ github.event.issue.body }}

      # Debug step
      - name: Debug md2jira output
        run: echo "OUTPUT = >>>${{ steps.md2jira.outputs.output-text }}<<<"

      - name: Debug details
        run: echo "DETAILS = >>>${{ steps.issue-parser.outputs.details_md }}<<<"

      - name: Debug tasks
        run: echo "TASKS = >>>${{ steps.issue-parser.outputs.tasks_md }}<<<"

      # Jira ì´ìŠˆ ìƒì„±
      - name: Create Issue
        id: create
        uses: atlassian/gajira-create@v3
        with:
          project: TS # â† ì‹¤ì œ Jira í”„ë¡œì íŠ¸ í‚¤
          issuetype: Story # â† Jiraì—ì„œ ì‚¬ìš©í•  ì´ìŠˆ íƒ€ì…
          summary: "${{ github.event.issue.title }}"
          description: "${{ steps.md2jira.outputs.output_text }}"
          fields: |
            {
              "parent": {
                "key": "${{ steps.issue-parser.outputs.parent_key }}"
              }
            }

      - name: Log created issue
        run: echo "Jira Issue ${{ steps.issue-parser.outputs.parent_key }}/${{ steps.create.outputs.issue }} was created"

      # (ì„ íƒ) ë¸Œëœì¹˜ ìƒì„±
      - name: Checkout main again
        uses: actions/checkout@v4

      - name: Create branch with Ticket number
        run: |
          BRANCH_NAME="${{ steps.issue-parser.outputs.branch_prefix }}/#${{ steps.issue-parser.outputs.parent_key }}-${{ steps.issue-parser.outputs.branch_name }}"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

      # (ì„ íƒ) GitHub ì´ìŠˆ ì œëª© ì—…ë°ì´íŠ¸
      - name: Update issue title on GitHub
        uses: actions-cool/issues-helper@v3
        with:
          actions: update-issue
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "${{ steps.create.outputs.issue }} ${{ github.event.issue.title }}"
